# ============================================================================
# DockWarden - Docker Compose with Secrets
# Secure setup using Docker secrets for registry authentication
# ============================================================================

services:
  dockwarden:
    image: emon5122/dockwarden:latest
    container_name: dockwarden
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    secrets:
      - registry_auth
      - notification_url
    environment:
      # Update behavior
      - DOCKWARDEN_INTERVAL=300
      - DOCKWARDEN_CLEANUP=true
      - DOCKWARDEN_LABEL_ENABLE=false

      # Health monitoring
      - DOCKWARDEN_HEALTH_WATCH=true
      - DOCKWARDEN_HEALTH_ACTION=restart

      # Registry authentication via Docker secret
      - DOCKWARDEN_REGISTRY_SECRET=/run/secrets/registry_auth

      # Notifications via Docker secret
      - DOCKWARDEN_NOTIFICATION_URL_FILE=/run/secrets/notification_url

      # Logging
      - DOCKWARDEN_LOG_LEVEL=info
      - TZ=America/New_York
    security_opt:
      - no-new-privileges:true
    read_only: true

# ============================================================================
# Secrets Configuration
# ============================================================================
#
# Option 1: File-based secrets (for standalone Docker)
# Create these files before running:
#   ./secrets/registry-auth.json - Docker registry credentials
#   ./secrets/notification-url.txt - Webhook URL for notifications
#
# Option 2: External secrets (for Docker Swarm)
# Create secrets with:
#   docker secret create registry_auth ./secrets/registry-auth.json
#   docker secret create notification_url ./secrets/notification-url.txt
# Then change 'file:' to 'external: true'
# ============================================================================

secrets:
  registry_auth:
    file: ./secrets/registry-auth.json
  notification_url:
    file: ./secrets/notification-url.txt
# ============================================================================
# Example registry-auth.json format:
# ============================================================================
# {
#   "auths": {
#     "https://index.docker.io/v1/": {
#       "auth": "base64_encoded_username:password"
#     },
#     "ghcr.io": {
#       "auth": "base64_encoded_username:token"
#     }
#   }
# }
#
# Generate auth string with:
#   echo -n 'username:password' | base64
# ============================================================================
